This is a complete rewrite of the database layer. All database layer code